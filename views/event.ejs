<% include _header.ejs %>
<% include _event-navbar.ejs %>

<script>
    // Initial data
    var IS_ADMIN = <%= event && user.isAdminOf(event) %>;
    <% if(!_.isUndefined(event)) { %>
        var EVENT_ATTRS = <%- JSON.stringify(event.toClientJSON()) %>;
        var SESSION_ATTRS = <%- JSON.stringify(event.get("sessions").invoke("toClientJSON")) %>;
        var HOA_ATTRS = <%- event.get("hoa") && user.isAdminOf(event) ? JSON.stringify(event.get("hoa").toClientJSON()) : "null" %>;
        var CONNECTED_USERS = <%- JSON.stringify(event.get("connectedUsers").invoke("toClientJSON")) %>
        var RECENT_MESSAGES = <%- JSON.stringify(event.get("recentMessages")) %>;
    <% } %>

</script>

<div class="container event-page-container">
    <div id="app">
        <div class="row">
            <div id="global"></div>
            <div id="dialogs"></div>
        </div> 

        <div class="row" id="main">

            <div id="top"></div> 

            <div class="col-lg-5 col-xs-5 left">
                <div id="top-left"></div>
                <div id="main-left"></div> 
            </div>

            <div class="col-lg-7 col-xs-5 right">
                <div id="main-right"></div>
            </div> 

        </div> 
    </div>

</div> 

<!-- event templates -->
<script type="text/template" id="about-event-template">
        
        <div class="container about-event-container">
            <h2>{{- title }}</h2>
            {{ if (organizer) { }}
                <h3>hosted by {{= organizer }}</h4>
            {{ } }}
            <br/>
            <h4>
            {{ if (formattedDate) { }}
                {{- formattedDate }}
            {{ } }}
            </h4>

            <br/><br/>

            <p>{{= description }}</p>

            {{ if (event.get("open")) { }}

                <a class="scroll-up pull-right" href="#about-nav">
                    <i class="icon-chevron-up chevron"></i>
                </a>

            {{ } else { }}
                <div class="about-footer"><i>This event has not yet started, come back at the posted start time to participate!</i></div>
            {{ } }}
        </div>

</script>

<script type="text/template" id="session-template">
    <div class="col-lg-12 col-xs-12 session-area">
        <h3 class="col-lg-8 col-xs-8">{{- title }}</h3>
        
        {{ if (IS_ADMIN) { }}
            <div class="col-lg-3 col-xs-3 btn-admin-join-session">
                <button class="attend btn btn-success" data-toggle="button">
                    <span class="outer"><i class="lock fa fa-lock"></i><span class="text">LOCKED</span></span>
                    <div class="attendance"></div>
                </button>
            </div>

            <div class="col-lg-1 col-xs-1 btn-admin-delete-session">   
                <button class="delete btn btn-warning"><i class="fa fa-trash-o"></i></button>
            </div>
        {{ } else { }}
            <div class="col-lg-4 col-xs-4 btn-join-session">
                <button class="attend btn btn-success" data-toggle="button">
                    <span class="outer"><i class="lock fa fa-lock"></i><span class="text">LOCKED</span></span>
                    <div class="attendance"></div>
                </button>
            </div>

        {{ } }}
    </div>

    
    <div class="col-lg-12 col-xs-12 session-spots">
        <ul class="hangout-users"></ul>
    </div>

    <div class="hangout-offline">
        No one has joined this session yet.
    </div>
</script>

<script type="text/template" id="session-list-template">
    <div id="session-list-container" class="full-size-container">
        <div class="credits">powered by <a href="https://unhangout.media.mit.edu/">unhangout</a> from the <a href="http://media.mit.edu/">MIT Media Lab</a></div>
    </div>
    <div style='clear: both;'></div>
</script>

<script type="text/template" id="session-list-empty-template">
    <div id="session-list-container" class="full-size-container">
        <div class="empty-notice">Sessions will appear here when they are created by an admin.</div>
        <div class="credits">powered by <a href="https://unhangout.media.mit.edu/">unhangout</a> from the <a href="http://media.mit.edu/">MIT Media Lab</a></div>
    </div>
    <div style='clear: both;'></div>
</script>

<script type="text/template" id="pagination-template">
    <div class="footer">
        <div id="prev">prev</div>
            {{ _.each(info().pageSet, function(page) { }}
                {{ if(page==currentPage) { }}
                    <div class="active page">{{- page }}</div>
                {{ } else { }}
                    <div class="page">{{- page }}</div>
                {{ } }}
            {{ }) }}
            <div id="next">next</div>
        </div>
    </div>
</script>

<script type="text/template" id="user-template">
    {{ if(!picture) { }}
        <i class="fa fa-user"></i>
    {{ } else if (link) { }}
        <a href="{{- link }}" target="_new"><img src="{{- picture}}" alt='profile'></a>
    {{ } else { }}
        <img src="{{- picture}}" alt='profile'>
    {{ } }}
</script>

<script type="text/template" id="user-list-template">
    <div class="header">
        <span class="contents">{{- numUsers}}</span><i class="fa fa-user"></i>
    </div>
    <div id="user-list-scroll-container">
        <ul id="user-list-container"></ul>
    </div>
</script>

<script type="text/template" id="chat-message-template">
    <span class="from">{{- user.shortDisplayName}}</span>{{= text}}
</script>

<script type="text/template" id="chat-layout">
     <div id="chat-container-region" class="col-lg-10 col-xs-10">
        <div class="panel">
            <div class="panel-heading">
                <div id='welcome-message'></div>
            </div>

            <div class="panel-body">
                <div id='chat-messages'></div>
            </div>

            <div class="panel-footer">
                <div id="chat-input-region"></div>
            </div>
        </div>
    </div>
    
    <div id="presence-gutter" class="col-lg-2 col-xs-2"></div>
</script>

<script type="text/template" id="welcome-message-template">
    {{= welcomeMessage }}
    {{ if (chatArchiveUrl) { }}
        <div class='chat-archive-link'>
            <a href='{{= chatArchiveUrl }}' target='_blank'>Chat Archive</a>
        </div>
    {{ } }}
</script>

<script type="text/template" id="chat-input-template">
    <form><input type="text" id="chat-input" class="form-control" autocomplete="off" placeholder='Type your message here'></input></form>
</script>

<script type="text/template" id="chat-template">
    <ul id="chat-list-container"></ul>
    <div class='over-capacity-warning'>
        <i class='fa fa-fire-extinguisher'></i>
        Oh no! The server is overloaded and couldn't send your message. Please
        try again soon.
    </div>
</script>

<script type="text/template" id="user-column-layout-template">
    <div id="user-list"></div>
    <div id="footer"></div>
</script>

<script type="text/template" id="video-embed-template">
    <div class='video-player'></div>
    <div class='video-controls row'></div>
</script>

<script type='text/template' id="video-embed-controls-template">
    {{ if (youtubeEmbed) { }}
        <div class="row video-play-trash-row">
            <div class='col-lg-6 col-xs-6 btn-play-pause'>
                <div class='current-video-controls'>
                    <button class='btn btn-success play-for-all'>
                        {{ if (isPlayingForEveryone) { }}
                            <i class='fa fa-pause'></i> Pause for All
                        {{ } else if (isAwaitingStart) { }}
                            <i class='fa fa-clock-o'></i> Awaiting Start
                        {{ } else { }}
                            <i class='fa fa-play'></i> Play for All
                        {{ } }}
                        <span class='button-time-indicator'></span>
                    </button> 
                </div>
            </div>

            <div class="col-lg-1 col-xs-1 btn-video-trash">
                <button class='btn btn-danger remove-video' title="Remove video embed">
                    <i class='fa fa-trash-o'></i>
                </button>
            </div>

        </div>
    {{ } }}

    <div class='row youtube-video-controls'>

        <div class="col-lg-8 col-xs-8 input-video-field">
            <input class="form-control" type="text" name="youtube_id" value="" placeholder="Paste Youtube URL Here" />

            {{ if (previousVideoEmbeds.length > 0) { }}
               
                    <button class='btn btn-default dropdown-toggle' data-toggle="dropdown">
                        <i class='fa fa-list'></i>
                        <i class='fa fa-caret-down'></i>
                    </button>


                    <ul class="dropdown-menu previous-videos" role="menu">
                        <li role="presentation"><a class='restore-previous-video header'>Previous videos</a></li>
                        {{ _.each(previousVideoEmbeds, function(vid) { }}

                            <li role="presentation">
                                <a role="menuitem" class='restore-previous-video'
                                   data-youtube-id='{{= vid.youtubeId }}'>{{= vid.youtubeId }}  
                                </a>

                                <!--<button class='btn btn-danger remove-one-previous-video'
                                    data-youtube-id='{{= vid.youtubeId }}'><i class='fa fa-trash'></i></button>-->
                                
                            </li>
                        {{ }); }}

                        <li><a class='clear-previous-videos'>
                            <i class='fa fa-trash-o'></i> Clear list
                        </a></li>
                    </ul>
               
            {{ } }}
        </div>

        <!--<div class="col-lg-3 col-xs-4 btn-video-embed">
            <button class='btn btn-default enqueue-video'
            type="button">Enqueue</button>
        </div>-->

        <div class="col-lg-3 col-xs-4 btn-video-embed">
            <button class='btn btn-default set-video'
            type="button">Embed for All</button>
        </div>

        <!--<p class="alert text-warning">Unrecognized youtube URL.  Please use the URL for a single video.</p>-->

        <div class="col-lg-12 col-xs-12 alert alert-warning alert-dismissible text-warning" role="alert">
          <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <strong>Warning!</strong> Unrecognized youtube URL! Please try again.
        </div>

        <div class="col-lg-12 col-xs-12 OR-field">
            <p>OR</p>
        </div>
        
      
        {{ if (hoaParticipationLink) { }}
           
            <div class="col-lg-6 col-xs-6 btn-join-hoa">
                <a class="join-hoa" target='_blank'
                    href="{{= hoaParticipationLink }}">
                    <button class="btn btn-default hoa">
                        <i class="fa fa-users"></i> Join Hangout-on-Air
                    </button>
                </a>
            </div>

            <div class="col-lg-6 col-xs-6 btn-remove-hoa">
                <button class='btn btn-danger remove-hoa'>Remove Hangout-on-Air
                </button>
            </div>
            
        {{ } else { }}
            
            <div class="col-lg-8 col-xs-8 btn-hoa">
                <a class="btn btn-default create-hoa hoa" target="_blank"
                    href='/event/{{- id }}/create-hoa/'>
                <i class='fa fa-users'></i> Create Hangout-on-Air
                </a>
            </div>
        
        {{ } }}
      
    </div>
    
</script>

<script type='text/template' id="previous-video-details-template">
    <a tabindex='-1' href='#' class='restore-previous-video'
       style='text-align: left;'
       title='{{= title }}'
       data-youtube-id='{{= id }}'>
        <img src='{{= thumbnail.url }}' style='width: 64px; height: 48px' alt='thumbnail'>
        <span class='title'>{{= title }}</span>
        <span class='duration'>
            {{= parseInt(duration/60) }}:{{= (duration%60) < 10 ? "0" + (duration%60) : (duration%60) }}
        </span>
    </a>
</script>

<script type="text/template" id="admin-button-template">
    <div class="dropdown">
        <a class="dropdown-toggle admin-button" data-toggle="dropdown"
           id='event-settings-label'>Event Settings</a>

        <ul class="dropdown-menu" role="menu" aria-labelledby="event-settings-label">
            <li role="presentation">
                {{ if (event.get("open")) { }}
                    <a role="menuitem" href="#" role="buton" id='admin-stop-event'>
                        <i class='fa fa-stop fa-lg fa-fw'></i>
                        Stop event
                    </a>
                {{ } else { }}
                    <a role="menuitem" href="#" role="buton" id='admin-start-event'>
                        <i class='fa fa-play fa-lg fa-fw'></i>
                        Start event
                    </a>
                {{ } }}
                <a role="menuitem" href="#create-session-modal" data-toggle="modal" id="show-create-session-modal">
                    <i class="fa fa-plus-square fa-lg fa-fw"></i>&nbsp;Create Session
                </a>
                <a role="menuitem" href="/admin/event/" role="button" id="admin-page-for-event">
                    <i class="fa fa-pencil-square-o fa-lg fa-fw"></i>
                    Edit Event Info
                </a>
                {{ if (event.get("sessionsOpen")) { }}
                    <a role="menuitem" tabindex="-1" id="close-sessions" href='#'>
                        <i class="fa fa-lock fa-lg fa-fw"></i>
                        Close Sessions
                    </a>
                {{ } else { }}
                    <a role="menuitem" tabindex="-1" id="open-sessions" href='#'>
                        <i class="fa fa-unlock fa-lg fa-fw"></i>
                        Open Sessions
                    </a>
                {{ } }}
                <a role="menuitem" id="message-sessions" href='#' data-toggle="modal">
                    <i class="fa fa-share fa-lg fa-fw"></i>
                    Send Message to Sessions
                </a>
            </li>
        </ul>
    </div>

    <!-- This is a workaround to display dropdown menu. Looks like a bug: http://laravel.io/forum/02-22-2014-twitter-bootstrap-311-not-displaying-dropdown-items -->

    <script type="text/javascript">
        $('.dropdown-toggle').dropdown();

        //Hide the youtube and webpage url form controls
        $(".youtube-url").hide();
        $(".webpage-url").hide();
        $(".join-cap-error").hide();
        $(".text-warning").hide();

    </script>

</script>

<script type="text/template" id="session-live-bar-template">
    <div>Your session is now live!</div>
    <a class="btn btn-success" target="_blank">Join Hangout!</a>
</script>

<script type="text/template" id="dialogs-template">

    <!-- Create Session Modal Dialog -->
    <div id="create-session-modal" class="modal fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="form-horizontal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Create Session</h4>
            </div>

          <div class="modal-body">
            
            <div class="form-group">
                <label class="col-lg-3 control-label" for="session_name">Session Name</label>

                <div class="col-lg-9">
                    <input class="form-control" type="text" name="session_name" value="" id="session_name">
                </div>
            </div>

            <div class="form-group">
                <label class="col-lg-3 control-label" for='join_cap'>Participant Limit</label>

                <!--<span class='help-block join-cap-error hide'>
                   Please enter a number between 2 and 10.
                </span>-->


                <div class="col-lg-4">
                    <input class="form-control" type='number' min='2' max='10' step='1'
                       value='10' 
                       name='join_cap' id='join_cap' />
                    <span class='help-inline'>Minimum 2, maximum 10</span>
                </div>
            </div>

            <div class="form-group">
                <div class="col-lg-offset-1 col-lg-10 alert alert-warning alert-dismissible join-cap-error" role="alert">
                  <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                  Warning! Please enter a number between 2 and 10.
                </div>
            </div>

             <div class="form-group">
                     
                <label class="col-lg-3 control-label">
                    Session Type
                </label>

                <div class="col-lg-9">
                    <label class="radio-inline">
                      <input type="radio" name="session_type" value="simple" checked="checked"/> Simple 
                    </label>

                    <label class="radio-inline">
                      <input type="radio" name="session_type" value="video" /> Youtube Video
                    </label>

                    <label class="radio-inline">
                      <input type="radio" name="session_type" value="webpage"  /> Webpage
                    </label>
                    
                    <div class='form-group youtube-url'>
                        <p class="yt-error hide">
                            Unrecognized youtube URL.  Please use the URL for a single video.
                        </p>

                        <label class="col-lg-4 control-label" for="session_youtube_id">Youtube URL</label>
                        
                        <div class="col-lg-8">

                            <input class="form-control" type="text" name="youtube_id" value=""
                                   id="session_youtube_id"
                                   placeholder='https://youtube.com'>

                            <span class='help-block'>Paste the URL or embed code for a youtube video.</span>

                        </div>
                    </div>

                    <div class='form-group webpage-url'>
                        <label class="col-lg-4 control-label" for='session_webpage'>Webpage URL</label>

                        <div class="col-lg-8">

                            <input class="form-control" type='text' placeholder='https://example.com' id='session_webpage'/>

                            <div class='url-error hide' style='display: none;'>
                                Sorry, but only secure pages (those starting with "https")
                                can be embedded in hangouts.
                            </div>
                        </div>

                    </div>
                </div>
            </div>
          </div> 

          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

            <button type="button" class="btn btn-primary" id="create-session" value="Create Session" data-dismiss="modal">Create Session</button>
          </div>

        </div>
      </div>
      </form>

    </div>

    <!-- Send messages to session dialog -->
    <div id="message-sessions-modal" class="modal fade" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <form class="form-horizontal">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Send Message to All Hangout Sessions</h4>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label for='session_message' class="control-label col-lg-3">Message</label>

                        <div class="col-lg-9">
                            <textarea class="form-control" id='session_message' rows=5 cols=30></textarea>

                            <a class='add-url-to-message' style='cursor: pointer;'>
                                Add URL to event page
                                <i class='fa fa-level-up'></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="control-label col-lg-3" for='session_message'>Message Preview</label>

                        <div class="col-lg-9">
                            <div class='faux-hangout-notice'>
                                <div class='message'></div>
                                <div class='close'>&times;</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class='modal-footer'>

                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="send-session-message" value="Send Message">Send Message</button>

                </div>
            </div>
            </form>
        </div>
    </div>

    <div class="modal hide fade started-modal">
        <div class="modal-header"><h3></h3></div>
        <div class="modal-body">
            <p>It is time to join your session!</p>
            <a class="btn btn-success join-chosen-session" target="_blank">JOIN HANGOUT</a>
        </div>
    </div>

    <div class="modal fade disconnected-modal" id="disconnected-modal" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Warning!</h4>
                </div>

                <div class="modal-body">
                    <p>An unexpected error has occured. You have been disconnected from the server. Please refresh the page to reconnect.</p>
                </div>

                <div class="modal-footer">
                     <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
            
    <div id="no-urls-warning" class="modal hide fade">
        <div class="modal-header"><h3>NO HANGOUT URLS AVAILABLE</h3></div>
        <div class="modal-body">
            <p>There are currently no hangout urls available on the server. Sessions started when there are no urls available will fall back to the callback method of hangout starting, which requires the first person to join a session to create the hangout. This is not desireable; we strongly recommend you farm some hangout urls by clicking "farm" below. For this process to work, your google acount must have "create video calls for events" set in your google calendar account settings.
        </div>
        <div class="modal-footer">
            <a class="btn btn-success" id="farm-urls" href="/hangout-farming" target="_blank">Farm</a>
            <a href="#" class="btn btn-primary" id="dismiss-farming-warning" data-dismiss='modal'>Dismiss</a>
        </div>
    </div>

    
</script>

<% include _video-templates.ejs %>

<%- requireScripts("/public/js/event-app.js") %>
<% include _analytics.ejs %>
<% include _preload-facilitator.ejs %>
<% include _footer.ejs %>
